<title>任务看板 - 页面示例</title>

<link rel="stylesheet" href="/lib/bootstrap-select/dist/css/bootstrap-select.css">
<link rel="stylesheet" href="/lib/jquery-selective/jquery-selective.css">
<link rel="stylesheet" href="/lib/bootstrap-datepicker/dist/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/lib/bootstrap-markdown/css/bootstrap-markdown.min.css">
<link rel="stylesheet" href="/lib/jquery-slidePanel/dist/css/slidePanel.css">

<style>
.page-taskboard .ui-tooltip {
    display: none!important
}

.page-taskboard .ui-helper-hidden-accessible {
    display: none
}

.page-taskboard .control-content .bootstrap-select {
    width: 100%!important
}

.page-taskboard .page {
    height: -webkit-calc(100% - 44px);
    height: calc(100% - 44px);
    overflow: hidden
}

.page-taskboard .page-content {
    height: -webkit-calc(100% - 91px);
    height: calc(100% - 91px);
    width: 100%;
    overflow-x: auto
}

.page-taskboard .subtasks .checkbox-custom input:checked+label {
    text-decoration: line-through
}

.slidePanel .overlay-panel a:not([class]) {
    text-decoration: none
}

.slidePanel-header .btn .focus,.slidePanel-header .btn:focus,.slidePanel-header .btn:hover {
    color: #e4eaec
}

.slidePanel-actions {
    min-height: 0
}

.slidePanel-actions .btn {
    line-height: 1em
}

.slidePanel-inner {
    padding: 0 30px
}

.slidePanel .caption {
    font-size: 22px;
    font-weight: 400;
    line-height: 1
}

.slidePanel .priority .list-inline>li {
    padding-left: 20px;
    padding-right: 0
}

.slidePanel .priority .list-inline>li label {
    font-size: 0;
    color: transparent
}

.slidePanel .priority .list-inline-item {
    display: inline-block
}

.slidePanel .addMember {
    margin-top: 30px;
    margin-bottom: 20px
}

.slidePanel .addMember-trigger {
    vertical-align: top
}

.slidePanel .addMember-items {
    display: inline
}

.slidePanel .addMember-item {
    margin-bottom: 10px
}

.slidePanel .addMember-trigger-dropdown {
    left: auto;
    top: 40px;
    z-index: 1
}

.slidePanel .addMember-trigger-dropdown:before {
    border-color: transparent transparent #fff;
    left: 4px;
    top: -20px
}

.slidePanel .description-content {
    margin-bottom: 20px
}

.slidePanel .description-toggle {
    display: none;
    margin-bottom: 20px
}

.slidePanel .attachments-list,.taskboard-list {
    margin-bottom: 0
}

.slidePanel .description.is-empty .description-toggle {
    display: inline-block
}

.slidePanel .radio-custom.radio-high label::before {
    border-color: #eb6709
}

.slidePanel .radio-custom.radio-high label::after {
    border-color: #fff
}

.slidePanel .radio-custom.radio-urgent label::before {
    border-color: #ff4c52
}

.slidePanel .radio-custom.radio-urgent label::after {
    border-color: #fff
}

.slidePanel .overlay-panel .dropdown-menu {
    color: #76838f
}

.slidePanel .subtasks-add {
    display: none
}

.slidePanel .subtasks.is-edit .subtasks-add {
    display: block
}

.slidePanel .subtasks-list .checkbox-custom {
    margin-top: 0;
    margin-bottom: 0
}

.slidePanel .subtasks .subtask.is-edit .checkbox-custom,.slidePanel .subtasks-list .subtask-editor {
    display: none
}

.slidePanel .subtasks .subtask.is-edit .subtask-editor {
    display: block
}

.slidePanel .attachments .list-group-item:hover .attachments-actions {
    display: inline-block
}

.slidePanel .attachments .list-group-item .size {
    display: inline-block;
    width: 80px;
    color: #a3afb7
}

.slidePanel .attachments-actions,.slidePanel .task-section {
    display: none
}

.slidePanel .attachments-image {
    width: 80px;
    line-height: 70px;
    text-align: center;
    border: 1px solid #e4eaec;
    padding: 2px
}

.slidePanel .attachments-image>img {
    max-width: 100%;
    max-height: 100%
}

.slidePanel .attachments .btn {
    padding-top: 0;
    padding-bottom: 0;
    line-height: 1;
    vertical-align: baseline;
    color: #a3afb7
}

.slidePanel .attachments .btn:hover,.taskboard-stage-actions a {
    color: #76838f
}

.slidePanel .attachments .icon {
    margin-right: 0
}

.slidePanel .slidePanel-inner-section:last-child {
    border-bottom: none
}

.slidePanel .task-section.is-show {
    display: block
}

.slidePanel .task-main.is-edit .task-main-surface {
    display: none
}

.slidePanel .task-main.is-edit .task-main-editor {
    display: block
}

.slidePanel #fileupload,.slidePanel .task-main-editor {
    display: none
}

.taskboard-stages {
    height: 100%;
    position: relative;
    list-style: none;
    padding: 0;
    margin: 0;
    white-space: nowrap
}

.taskboard-stage {
    position: relative;
    display: inline-block;
    vertical-align: top;
    width: 260px;
    height: 100%;
    margin-right: 30px;
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 1px rgba(0,0,0,.05);
    border-width: 0;
    margin-top: -1px
}

.taskboard-stage.ui-sortable-helper {
    max-height: none
}

.taskboard-stage-rename-wrap {
    display: none;
    padding: 6px 10px!important
}

.taskboard-stage-header {
    padding: 16px 20px;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    border-bottom: 1px solid #e4eaec;
    background-color: #fafafa
}

.taskboard-stage-header h2,.taskboard-stage-header h3,.taskboard-stage-header h4,.taskboard-stage-header h5,.taskboard-stage-header h6,.taskboard-stage-header>h1 {
    margin: 0
}

.taskboard-list .list-group-item .task-badge.icon:before,.taskboard-stage-content .add-item-toggle>.icon {
    margin-right: 6px
}

.taskboard-stage-header .dropdown-menu {
    left: -10px
}

.taskboard-stage-header .dropdown-menu>li {
    width: 200px
}

.taskboard-stage-header .dropdown-menu>li>a {
    overflow: hidden;
    text-overflow: ellipsis
}

.taskboard-stage-header .dropdown-menu.is-edit [role=menuitem] {
    display: none
}

.taskboard-stage-header .dropdown-menu.is-edit .taskboard-stage-rename-wrap {
    display: block
}

.taskboard-stage-actions a.open,.taskboard-stage-actions a:hover {
    color: #a3afb7
}

.taskboard-stage-content {
    height: -webkit-calc(100% - 49px);
    height: calc(100% - 49px);
    overflow: auto
}

.taskboard-stage-content .action-wrap {
    padding: 20px
}

.taskboard-stage-content .action-wrap.action-open .add-item-toggle {
    display: none
}

.taskboard-stage-content .action-wrap.action-open .add-item-wrap {
    display: block
}

.taskboard-stage-content .add-item-toggle {
    display: block;
    color: #37474f
}

.taskboard-stage-content .add-item-toggle:focus,.taskboard-stage-content .add-item-toggle:hover {
    color: #76838f;
    text-decoration: none
}

.taskboard-stage-content .add-item-wrap {
    display: none
}

.taskboard-stage-content .add-item-priority {
    display: block
}

.taskboard-list {
    min-height: 30px;
    margin-top: -1px
}

.taskboard-list .list-group-item {
    padding: 12px 20px;
    border-top: 1px solid #e4eaec;
    border-bottom: 1px solid #e4eaec;
    border-left: 3px solid transparent;
    cursor: pointer
}

.taskboard-list .list-group-item::after {
    display: block;
    clear: both;
    content: ""
}

.taskboard-list .list-group-item .task-badge {
    float: left;
    margin-top: 10px;
    color: #a3afb7;
    line-height: 30px
}

.taskboard-list .list-group-item .task-members {
    float: right;
    text-align: right;
    white-space: normal;
    padding: 0
}

.taskboard-list .list-group-item .task-members>li {
    display: inline-block;
    margin-left: 6px;
    margin-top: 10px
}

.taskboard-list .list-group-item.priority-high {
    border-left-color: #eb6709
}

.taskboard-list .list-group-item.priority-urgent {
    border-left-color: #ff4c52
}

.taskboard-list .list-group-item:first-child,.taskboard-list .list-group-item:last-child {
    border-radius: 0
}

.taskboard-list .list-group-item.ui-sortable-helper {
    border-color: #e4eaec
}

.taskboard-list .list-group-item.ui-sortable-placeholder {
    background-color: #e4eaec;
    visibility: visible!important
}

.taskboard-list .list-group-item>.checkbox-custom {
    margin: 0
}

.taskboard-list .list-group-item>.checkbox-custom input:checked+label {
    text-decoration: line-through
}

.taskboard-list .list-group-item>.list-group-item-title {
    margin-left: 30px;
    white-space: normal
}
</style>

<div class="page animation-fade page-taskboard">
    <div class="page-header">
        <h1 class="page-title">任务看板</h1>
    </div>
    <div class="page-content">
        <ul class="taskboard-stages" id="taskboard-stages"></ul>
    </div>
    <button class="site-action site-floataction btn-raised btn btn-success btn-floating" type="button" data-toggle="modal"
            data-target="#addStageFrom">
        <i class="icon wb-plus" aria-hidden="true"></i>
    </button>
</div>

<div class="modal fade" id="addStageFrom" aria-hidden="true" aria-labelledby="addStageFrom" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" aria-hidden="true" data-dismiss="modal">×</button>
                <h4 class="modal-title">新建分组</h4>
            </div>
            <div class="modal-body">
                <form action="#" method="post" role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" id="name" name="name" placeholder="分组名称">
                    </div>
                </form>
            </div>
            <div class="modal-footer text-left">
                <button id="taskboard-stage-creat" class="btn btn-primary" data-dismiss="modal" type="button">
                    创建
                </button>
                <a class="btn btn-sm btn-white" data-dismiss="modal" href="javascript:;">取消</a>
            </div>
        </div>
    </div>
</div>


<script src="/vendor/jquery-ui/jquery-ui.min.js"></script>
<script src="/vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
<script src="/vendor/jquery-selective/dist/jquery-selective.min.js"></script>
<script src="/vendor/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js" data-name="datepicker"></script>
<script src="/vendor/bootstrap-datepicker/dist/locales/bootstrap-datepicker.zh-CN.min.js" data-deps="datepicker"></script>
<script src="/vendor/bootstrap-markdown/js/bootstrap-markdown.js" data-name="markdown"></script>
<script src="/vendor/bootstrap-markdown/locale/bootstrap-markdown.zh.js" data-deps="markdown"></script>
<script src="/vendor/bootbox.js/dist/bootbox.all.min.js"></script>
<script src="/vendor/jquery-slidePanel/dist/jquery-slidePanel.min.js"></script>

<script>
/**
 * QAdmin v1.2.0 (http://www.qadmin.com/)
 * Copyright 2015-2017 QAdmin Team
 * Licensed under the QAdmin License 1.0 (http://www.qadmin.com/about/#license)
 */
(function (document, window, $) {
    'use strict';

    bootbox.setDefaults($.po('bootbox'));
    var $pageContent = $('#qadmin-pageContent');
    
    window.Content = {
        stageTpl: function (title) {
            return '<li class="taskboard-stage">' +
                '<header class="taskboard-stage-header">' +
                    '<div class="taskboard-stage-actions float-right">' +
                        '<div class="dropdown">' +
                            '<a data-toggle="dropdown" href="#" aria-expanded="false"><i class="icon wb-chevron-down" aria-hidden="true"></i></a>' +
                            '<div class="dropdown-menu bullet" role="menu">' +
                                '<a role="presentation" class="dropdown-item taskboard-stage-rename"><i class="icon wb-pencil" aria-hidden="true"></i>重命名</a>' +
                                '<a role="presentation" class="dropdown-item taskboard-stage-delete" ><i class="icon wb-trash" aria-hidden="true"></i>删除</a>' +
                                '<div class="dropdown-item taskboard-stage-rename-wrap">' +
                                    '<div class="form-group">' +
                                        '<input class="form-control taskboard-stage-rename-input" type="text" value="' + title + '" name="name">' +
                                    '</div>' +
                                    '<button class="btn btn-primary btn-block taskboard-stage-rename-save" type="button">保存</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<h5 class="taskboard-stage-title">' + title + '</h5>' +
                '</header>' +
                '<div class="taskboard-stage-content">' +
                '<ul class="list-group taskboard-list">' +
                '</ul>' +
                '<div class="action-wrap">' +
                '<a class="add-item-toggle" href="#"><i class="icon wb-plus" aria-hidden="true"></i>添加任务</a>' +
                '<div class="add-item-wrap">' +
                '<form class="add-item" role="form" method="post" action="#">' +
                '<div class="form-group">' +
                '<label class="control-label margin-bottom-15" for="name">任务名称：</label>' +
                '<input class="form-control" type="text" placeholder="任务名称" name="name">' +
                '</div>' +
                '<div class="form-group text-right">' +
                '<a class="btn btn-sm btn-white add-item-cancel">取消</a>' +
                '<button type="button" class="btn btn-primary add-item-add">添加</button>' +
                '</div>' +
                '</form>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</li>';
        },

        taskTpl: function (data) {
            return '<li class="list-group-item priority-' + data.priority + '" data-taskboard="slidePanel" data-url="/views/examples/pages_team/taskboard.tpl">' +
                '<div class="checkbox-custom checkbox-primary">' +
                '<input type="checkbox" ' + (data.complete ? 'checked="checked"' : '') + ' name="checkbox">' +
                '<label class="task-title">' + data.title + '</label>' +
                '</div>' +
                '<div class="task-badges"></div>' +
                '<ul class="task-members">' +
                '<li><img class="avatar avatar-sm" src="/static/images/portraits/5.jpg"></li>' +
                '</div>' +
                '</li>';
        },

        badgesTpl: function (type, content) {
            var html = '';
            switch (type) {
                case 'duedate':
                    html = '<span class="task-badge task-badge-subtask icon wb-calendar">' + content + '</span>';
                    break;
                case 'subtasks':
                    html = '<span class="task-badge task-badge-subtask icon wb-list-bulleted">' + content + '</span>';
                    break;
                case 'attachments':
                    html = '<span class="task-badge task-badge-attachments icon wb-paperclip">' + content + '</span>';
                    break;
                case 'comments':
                    html = '<span class="task-badge task-badge-comments icon wb-chat">' + content + '</span>';
                    break;
            }
            return html;
        },

        membersTpl: function (src) {
            return '<li><img class="avatar avatar-sm" src="' + src + '"></li>';
        },

        subtaskTpl: function (data) {
            return '<li class="list-group-item subtask">' +
                '<div class="checkbox-custom checkbox-primary">' +
                '<input type="checkbox" ' + (data.complete ? 'checked="checked"' : '') + ' name="checkbox">' +
                '<label class="title">' + data.title + '</label>' +
                '</div>' +
                '<div class="subtask-editor">' +
                '<form>' +
                '<div class="form-group">' +
                '<input class="form-control subtask-title" type="text" name="title">' +
                '</div>' +
                '<div class="form-group">' +
                '<button class="btn btn-primary subtask-editor-save" type="button">保存</button>' +
                '<a class="btn btn-sm btn-white subtask-editor-delete" href="javascript:;">删除</a>' +
                '</div>' +
                '</form>' +
                '</div>' +
                '</li>';
        },

        attachmentTpl: function (data) {
            return '<li class="list-group-item">' +
                '<div class="meida">' +
                '<div class="media-left">' +
                '<div class="attachments-image">' +
                '<img src="' + data.src + '">' +
                '</div>' +
                '</div>' +
                '<div class="media-body">' +
                '<p><span class="name">' + data.title + '</span><span</p>' +
                '<p>' +
                '<span class="size">' + data.size + '</span>' +
                '<span class="attachments-actions">' +
                '<button class="btn btn-icon btn-pure" type="button">' +
                '<i class="icon wb-download" aria-hidden="true"></i>' +
                '</button>' +
                '<button class="btn btn-icon btn-pure" type="button">' +
                '<i class="icon wb-trash" aria-hidden="true"></i>' +
                '</button>' +
                '</span>' +
                '</p>' +
                '</div>' +
                '</div>' +
                '</li>';
        },

        commentTpl: function (src, user, time, content) {
            return '<div class="comment media">' +
                '<div class="pr-20">' +
                '<a class="avatar avatar-lg" href="javascript:;">' +
                '<img src="' + src + '" alt="...">' +
                '</a>' +
                '</div>' +
                '<div class="media-body">' +
                '<div class="comment-body">' +
                '<a class="comment-author" href="javascript:;">' + user + '</a>' +
                '<div class="comment-meta">' +
                '<span class="date">' + time + '</span>' +
                '</div>' +
                '<div class="comment-content"><p>' + content + '</p></div>' +
                '</div>' +
                '</div>' +
                '</div>';
        },

        dataTpl: function () {
            var data = {
                "status": false,
                "title": "",
                "description": "",
                "priority": "normal",
                "duedate": "",
                "members": [],
                "subtasks": [],
                "attachments": [],
                "comments": []
            };
            return data;
        },

        init: function () {
            var self = this;
            $.getJSON($.ctx + '/views/examples/pages_team/taskboard.json', function (data) {
                var $wrap = $('#taskboard-stages');
                self.buildStage($wrap, data);
                self.initSortable();
            });
        },

        buildStage: function ($wrap, data) {
            if (data.length === 0) {
                return;
            }

            var self = this;
            $.each(data, function (n, info) {
                var $stage = $(self.stageTpl(info.title, info.type));
                self.buildTask($stage, info.tasks);
                $wrap.append($stage);
            });
        },

        buildTask: function ($wrap, data, once) {
            if (data.length === 0) {
                return;
            }

            var self = this,
                $container = $('.taskboard-list', $wrap);
            if (once) {
                var $task = $(self.taskTpl(data));
                self.buildBadges($task, data);
                $task.data('taskInfo', data);
                $wrap.append($task);
            } else {
                $.each(data, function (n, info) {
                    var $task = $(self.taskTpl(info));
                    self.buildBadges($task, info);
                    self.buildMembers($task, info.members);
                    $task.data('taskInfo', info);
                    $container.append($task);
                });
            }
        },

        buildBadges: function ($wrap, data) {
            var self = this,
                html = '',
                duedate = data.duedate,
                subtasks = data.subtasks,
                attachments = data.attachments,
                comments = data.comments;

            if (duedate.length > 0) {
                html += self.badgesTpl('duedate', duedate.split(/\//, 2).join("/"));
            }

            if (subtasks.length > 0) {
                var num = 0;
                $.each(subtasks, function (n, i) {
                    if (i.complete) {
                        num++;
                    }
                });

                html += self.badgesTpl('subtasks', num + '/' + subtasks.length);
            }

            if (attachments.length > 0) {
                html += self.badgesTpl('attachments', attachments.length);
            }

            if (comments.length > 0) {
                html += self.badgesTpl('comments', comments.length);
            }

            $wrap.find('.task-badges').html(html);
        },

        buildMembers: function ($wrap, data) {
            var self = this,
                html = '';
            if (data.length === 0) {
                return;
            }
            $.each(data, function (i, n) {
                html += self.membersTpl(n.img);
            });
            $wrap.find('.task-members').html(html);
        },

        //Sortable
        initSortable: function () {
            $('.taskboard-stages').sortable({
                handle: ".taskboard-stage-header"
            });
            $('.taskboard-stage .list-group').sortable({
                connectWith: ".taskboard-stage .list-group"
            });
        },

        //Stage
        handleAddStage: function () {
            var self = this;

            $pageContent.on('click', '.site-floataction', function () {
                var $model = $('#addStageFrom');

                $('input', $model).val('');
                $('option:first', $('select', $model)).prop("selected", 'selected');
            });

            $pageContent.on('click', '#taskboard-stage-creat', function () {
                var $model = $('#addStageFrom'),
                    $name = $('[name="name"]', $model);

                $('.taskboard-stages').append(self.stageTpl($name.val()));
                self.initSortable();
            });
        },

        handleDeleteStage: function () {
            $pageContent.on('click', '.taskboard-stage-delete', function () {
                var $this = $(this);
                bootbox.dialog({
                    message: "您确定要删除吗？",
                    buttons: {
                        success: {
                            label: "删除",
                            className: "btn-danger",
                            callback: function () {
                                $this.closest('.taskboard-stage').remove();
                            }
                        }
                    }
                });
            });
        },

        getStage: function ($task) {
            return $task.closest('.taskboard-stage');
        },

        //Stage Dropdown
        initStageDropdown: function () {
            $pageContent.on('click', '.taskboard-stage-actions .dropdown-toggle', function () {
                $(this).next('.dropdown-menu').removeClass('is-edit');

                //judge dropdown side
            });
        },

        handleStageRename: function () {
            $pageContent.on('click', '.taskboard-stage-rename', function (e) {
                var $header = $(this).closest('.taskboard-stage-header'),
                    $menu = $(this).closest('.dropdown-menu'),
                    $input = $('.taskboard-stage-rename-input', $menu),
                    $title = $('.taskboard-stage-title', $header);

                $menu.toggleClass('is-edit');
                $input.val('').focus().val($title.html());
                e.stopPropagation();
            });

            $pageContent.on('click', '.taskboard-stage-rename-save', function () {
                var $header = $(this).closest('.taskboard-stage-header'),
                    $input = $('.taskboard-stage-rename-input', $header),
                    $title = $('.taskboard-stage-title', $header),
                    value = $input.val();

                if (value.length === 0) {
                    return;
                }

                $title.html(value);
            });
        },

        //Task
        handleAddTask: function () {
            var self = this;

            $pageContent.on('click', '.add-item-toggle, .add-item-add, .add-item-cancel', function () {
                var $this = $(this),
                    $wrap = $this.closest('.action-wrap'),
                    $input = $('[name="name"]', $wrap);

                $wrap.toggleClass('action-open');
                if ($this.hasClass('add-item-toggle')) {
                    $input.val('');
                }

                if ($this.hasClass('add-item-toggle')) {
                    $pageContent.on('click.add-item', function (e) {
                        var $target = $(e.target);
                        if ($target.closest('.add-item-wrap').length === 0) {
                            $wrap.removeClass('action-open');
                            $pageContent.off('click.add-item');
                        }
                    });
                } else {
                    $pageContent.off('click.add-item');
                }
            });

            $pageContent.on('click', '.add-item-add', function () {
                var $this = $(this),
                    $wrap = $this.closest('.action-wrap'),
                    $input = $('[name="name"]', $wrap),
                    $list = $('.taskboard-list', $this.closest('.taskboard-stage-content')),
                    data = self.dataTpl();

                if ($input.val().length === 0) {
                    return;
                }

                data.title = $input.val();
                self.buildTask($list, data, true);
            });
        },

        handleDeleteTask: function () {
            $pageContent.on('click', '.taskboard-task-delete', function () {
                var $this = $(this);
                bootbox.dialog({
                    message: "确定要删除此任务吗？",
                    buttons: {
                        success: {
                            label: "删除",
                            className: "btn-danger",
                            callback: function () {
                                $this.closest('.slidePanel').data('slidePanel').target.remove();
                                $('.slidePanel-close').trigger('click');
                            }
                        }
                    }
                });
            });
        },

        handleTaskInput: function () {
            var self = this;
            $pageContent.on('click', '.taskboard-list .checkbox-custom input', function (e) {
                var $this = $(this),
                    $target = $this.closest('.list-group-item');

                self.dataChange($target, 'complete', $this.prop("checked"));
                e.stopPropagation();
            });
        },

        //Init SlidePanel
        handlSlidePanelPlugin: function () {
            if (typeof $.slidePanel === 'undefined') {
                return;
            }
            var self = this;

            $pageContent.on('click', '[data-taskboard="slidePanel"]', function (e) {
                var $target = $(e.target).closest('.list-group-item');
                $.slidePanel.show({
                    url: $(this).data('url'),
                    target: $target
                }, $.po('slidePanel', {
                    template: function (options) {
                        return '<div class="' + options.classes.base + ' ' + options.classes.base + '-' + options.direction + '">' +
                            '<div class="' + options.classes.base + '-scrollable"><div>' +
                            '<div class="' + options.classes.content + '"></div>' +
                            '</div></div>' +
                            '<div class="' + options.classes.base + '-handler"></div>' +
                            '</div>';
                    },
                    afterLoad: function (object) {
                        var _this = this,
                            $target = $(object.target),
                            info = $target.data('taskInfo');

                        this.$panel.find('.' + this.options.classes.base + '-scrollable')
                            .slimScroll($.po('slimScroll'));

                        this.$panel.find('#task-description').markdown({
                            language: 'zh'
                        });
                        if (info.duedate.length > 0) {
                            this.$panel.find('#taskDatepicker').data('date', info.duedate);
                        }
                        this.$panel.find('#taskDatepicker').datepicker($.po('datepicker',{
                            autoclose: false,
                            todayHighlight: true,
                            language:'zh-CN'
                        })).on('changeDate', function () {
                            $('#taskDatepickerInput').val(
                                _this.$panel.find('#taskDatepicker').datepicker('getFormattedDate')
                            );
                        });

                        this.$panel.data('slidePanel', object);

                        $pageContent.off('click.slidePanelDatepicker');
                        $pageContent.on('click.slidePanelDatepicker', 'span, td, th', function (e) {
                            e.stopPropagation();
                        });
                    },
                    afterShow: function () {
                        var self = this;
                        $pageContent.on('click.slidePanelShow', function (e) {
                            if ($(e.target).closest('.slidePanel').length === 0 && $(e.target).closest('body').length === 1) {
                                self.hide();
                            }
                        });
                    },
                    afterHide: function () {
                        $pageContent.off('click.slidePanelShow');
                        $pageContent.off('click.slidePanelDatepicker');
                    },
                    contentFilter: function (data, object) {
                        var $target = $(object.target),
                            info = $target.data('taskInfo'),
                            $panel = $(data),
                            $checked;

                        $('.stage-name', $panel).html($('.taskboard-stage-title', self.getStage($target)).html());

                        $('.task-title', $panel).html(info.title);

                        switch (info.priority) {
                            case 'high':
                                $checked = $('#priorityHigh', $panel);
                                break;
                            case 'urgent':
                                $checked = $('#priorityUrgent', $panel);
                                break;
                            default:
                                $checked = $('#priorityNormal', $panel);
                                break;
                        }
                        $checked.prop("checked", true);

                        self.handleSelective($('[data-plugin="jquery-selective"]', $panel), info.members);

                        if (info.description.length === 0) {
                            $('.description', $panel).addClass('is-empty');
                        } else {
                            $('.description-content', $panel).html(info.description);
                        }

                        if (info.subtasks.length !== 0) {
                            $.each(info.subtasks, function (n, subtask) {
                                var $subtask = $(self.subtaskTpl(subtask));
                                $('.subtasks-list', $panel).append($subtask);
                            });
                            $('.subtasks', $panel).toggleClass('is-show');
                        }

                        if (info.attachments.length !== 0) {
                            $.each(info.attachments, function (n, attachment) {
                                var $attachment = $(self.attachmentTpl(attachment));
                                $('.attachments-list', $panel).append($attachment);
                            });
                            $('.attachments', $panel).toggleClass('is-show');
                        }

                        if (info.comments.length !== 0) {
                            $.each(info.comments, function (n, comment) {
                                var $comment = $(self.commentTpl(comment.src, comment.user, comment.time, comment.content));
                                $('.comments-history', $panel).append($comment);
                            });
                        }

                        return $panel;
                    }
                }));

                e.stopPropagation();
            });

            $pageContent.on('click', '#fileuploadToggle', function () {
                $('#fileupload').trigger('click');
            });
        },

        //SlidePanel Section Handle
        handleSelective: function ($target, selected) {
            var self = this;
            var getSelected = function () {
                var _this = this,
                    arr = [];
                $.each(this._options.getOptions(this), function (n, option) {
                    $.each(_this.options.local, function (i, user) {
                        if (user.id === $(option).val()) {
                            arr.push(user);
                        }
                    });
                });
                return arr;
            };
            var members = [{
                id: 'uid_1',
                name: '梅小燕',
                img: '/static/images/portraits/1.jpg'
            }, {
                id: 'uid_2',
                name: '赵桦',
                img: '/static/images/portraits/2.jpg'
            }, {
                id: 'uid_3',
                name: '唐雪琴',
                img: '/static/images/portraits/3.jpg'
            }, {
                id: 'uid_4',
                name: '曹洁群',
                img: '/static/images/portraits/4.jpg'
            }, {
                id: 'uid_5',
                name: '陈媚婉',
                img: '/static/images/portraits/5.jpg'
            }, {
                id: 'uid_6',
                name: '嵇慧莉',
                img: '/static/images/portraits/6.jpg'
            }];

            $target.selective({
                namespace: 'addMember',
                local: members,
                selected: selected,
                buildFromHtml: false,
                tpl: {
                    optionValue: function (data) {
                        return data.id;
                    },
                    frame: function () {
                        return '<div class="' + this.namespace + '">' +
                            this.options.tpl.items.call(this) +
                            '<div class="' + this.namespace + '-trigger">' +
                            this.options.tpl.triggerButton.call(this) +
                            '<div class="' + this.namespace + '-trigger-dropdown">' +
                            this.options.tpl.list.call(this) +
                            '</div>' +
                            '</div>' +
                            '</div>';
                    },
                    triggerButton: function () {
                        return '<div class="' + this.namespace + '-trigger-button"><i class="wb-plus"></i></div>';
                    },
                    listItem: function (data) {
                        return '<li class="' + this.namespace + '-list-item"><img class="avatar" src="' + data.img + '">' + data.name + '</li>';
                    },
                    item: function (data) {
                        return '<li class="' + this.namespace + '-item"><img class="avatar" src="' + data.img + '">' +
                            this.options.tpl.itemRemove.call(this) +
                            '</li>';
                    },
                    itemRemove: function () {
                        return '<span class="' + this.namespace + '-remove"><i class="wb-minus-circle"></i></span>';
                    },
                    option: function (data) {
                        return '<option value="' + this.options.tpl.optionValue.call(this, data) + '">' + data.name + '</option>';
                    }
                },
                onAfterItemAdd: function () {
                    var $target = this.$el.closest('.slidePanel').data('slidePanel').target,
                        arr = getSelected.call(this);
                    self.dataChange($target, 'members', arr);
                },
                onAfterItemRemove: function () {
                    var $target = this.$el.closest('.slidePanel').data('slidePanel').target,
                        arr = getSelected.call(this);
                    self.dataChange($target, 'members', arr);
                }
            });
        },

        handlePriority: function () {
            var self = this;
            $pageContent.on('click', '[name="priorities"]', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target;

                self.dataChange($target, 'priority', $this.data('priority'));
            });
        },

        handleEditor: function () {
            var self = this;
            $pageContent.on('click', '.slidePanel .task-title, .taskboard-task-edit, .description-toggle', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    data = $target.data('taskInfo');

                $('#task-title').val(data.title);
                $('#task-description').val(data.description);
                $this.closest('.slidePanel').find('.task-main').addClass('is-edit');
            });

            $pageContent.on('click', '.task-main-editor-save', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target;

                self.dataChange($target, 'title', $('#task-title').val());
                self.dataChange($target, 'description', $('#task-description').val());

                $this.closest('.slidePanel').find('.task-main').removeClass('is-edit');
                if ($('#task-description').val().length === 0) {
                    $('.description').addClass('is-empty');
                } else {
                    $('.description').removeClass('is-empty');
                }
            });

            $pageContent.on('click', '.task-main-editor-cancel', function () {
                $(this).closest('.slidePanel').find('.task-main').removeClass('is-edit');
            });
        },

        handleSubtasks: function () {
            var self = this;
            $pageContent.on('click', '.subtask-toggle', function () {
                var length = $('.subtask').length,
                    $input = $('.subtasks-add .subtask-title'),
                    $subtasks = $('.subtasks');

                $input.val('');
                if (length === 0) {
                    $subtasks.addClass('is-show');
                }
                $subtasks.addClass('is-edit');

                $input.focus();

                $pageContent.on('click.subtask-add', function (e) {
                    var $target = $(e.target);
                    if ($target.closest($('.subtasks-add')).length === 0) {
                        $subtasks.removeClass('is-edit');
                        $pageContent.off('click.subtask-add');
                    }
                });
            });

            $pageContent.on('click', '.subtask-add-save', function () {
                var length = $('.subtask').length,
                    $subtasks = $('.subtasks'),
                    $input = $('.subtasks-add .subtask-title'),
                    value = $input.val(),
                    $target = $(this).closest('.slidePanel').data('slidePanel').target;

                if (value.length === 0) {
                    if (length === 0) {
                        $subtasks.removeClass('is-show');
                    }
                } else {
                    var data = {
                            'title': value,
                            'complete': false
                        },
                        $subtask = $(self.subtaskTpl(data));

                    $('.subtasks-list').append($subtask);
                    self.dataChange($target, 'subtasks', data, length);
                }
                $input.val('').focus();
            });

            $pageContent.on('click', '.subtask-add-cancel', function () {
                $('.subtasks').removeClass('is-edit');
                $pageContent.off('click.subtask-add');
            });

            $pageContent.on('click', '.subtask input', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    $subtask = $this.closest('.subtask'),
                    index = $subtask.index();

                self.dataChange($target, 'subtasks', $this.prop("checked"), index, 'complete');
            });

            $pageContent.on('click', '.subtask .title', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    data = $target.data('taskInfo'),
                    $subtask = $this.closest('.subtask'),
                    index = $subtask.index(),
                    $input = $('.subtask-title', $subtask);

                $subtask.addClass('is-edit');
                $input.val('').focus().val(data.subtasks[index].title);

                $pageContent.on('click.subtask', function (e) {
                    var $target = $(e.target);
                    if ($target.closest($subtask).length === 0) {
                        $subtask.removeClass('is-edit');
                        $pageContent.off('click.subtask');
                    }
                });
            });

            $pageContent.on('click', '.subtask-editor-save', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    $subtask = $this.closest('.subtask'),
                    index = $subtask.index();

                self.dataChange($target, 'subtasks', $('.subtask-title', $subtask).val(), index, 'title');
                $subtask.removeClass('is-edit');
                $pageContent.off('click.subtask');
            });

            $pageContent.on('click', '.subtask-editor-delete', function () {
                var $this = $(this);

                bootbox.dialog({
                    message: "确定要删除子任务吗？",
                    buttons: {
                        success: {
                            label: "删除",
                            className: "btn-danger",
                            callback: function () {
                                var $target = $this.closest('.slidePanel').data('slidePanel').target,
                                    $subtask = $this.closest('.subtask'),
                                    index = $subtask.index();
                                self.dataDelete($target, 'subtasks', index);
                                $subtask.remove();
                                $pageContent.off('click.subtask');
                                if ($('.subtask').length === 0) {
                                    $('.subtasks').removeClass('is-show');
                                }
                            }
                        }
                    }
                });

            });
        },

        handleDatepicker: function () {
            var self = this;
            $pageContent.on('click', '.due-date-save', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    value = $('#taskDatepickerInput').val();
                if (value.length > 0) {
                    self.dataChange($target, 'duedate', value);
                }
            });
            $pageContent.on('click', '.due-date-delete', function () {
                var $this = $(this),
                    $target = $this.closest('.slidePanel').data('slidePanel').target,
                    data = $target.data('taskInfo');
                if (data.duedate.length === 0) {
                    return;
                }
                self.dataDelete($target, 'duedate');
                $('#taskDatepicker').datepicker('clearDates');
            });
        },

        //Data
        dataDelete: function ($target, name, index) {
            if (index) {
                $target.data('taskInfo')[name].splice(index, 1);
                this.dataDeleteResponse($target, name, index);
            } else {
                $target.data('taskInfo')[name] = '';
                this.dataChangeResponse($target, name);
            }
        },

        dataDeleteResponse: function ($target, name) {
            switch (name) {
                case 'duedate':
                    this.buildBadges($target, $target.data('taskInfo'));
                    break;
                case 'subtasks':
                    this.buildBadges($target, $target.data('taskInfo'));
                    break;
            }
        },

        dataChange: function ($target, name, content, index, subname) {
            if (content.length === 0) {
                return;
            }
            if (index !== undefined) {
                if (subname) {
                    $target.data('taskInfo')[name][index][subname] = content;
                } else {
                    $target.data('taskInfo')[name][index] = content;
                }
            } else {
                $target.data('taskInfo')[name] = content;
            }
            this.dataChangeResponse($target, name, content, index, subname);
        },

        dataChangeResponse: function ($target, name, content, index, subname) {
            switch (name) {
                case 'title':
                    $('.task-title', $target).html(content);
                    $('.slidePanel .task-title').html(content);
                    break;
                case 'description':
                    $('.slidePanel .description-content').html(content);
                    break;
                case 'priority':
                    $target.removeClass('priority-normal priority-high priority-urgent').addClass('priority-' + content);
                    break;
                case 'duedate':
                    this.buildBadges($target, $target.data('taskInfo'));
                    break;
                case 'members':
                    this.buildMembers($target, $target.data('taskInfo').members);
                    break;
                case 'subtasks':
                    if (subname === 'title') {
                        $('.title', $('.subtasks-list .subtask')[index]).html(content);
                    } else {
                        this.buildBadges($target, $target.data('taskInfo'));
                    }
                    break;
                case 'attachments':
                    break;
                case 'comments':
                    break;
            }
        },

        run: function () {
            this.init();

            this.handleAddStage();
            this.handleDeleteStage();

            this.handleAddTask();
            this.handleDeleteTask();

            this.handleTaskInput();

            this.initStageDropdown();
            this.handleStageRename();

            this.handleDatepicker();
            this.handlSlidePanelPlugin();

            this.handleEditor();
            this.handleSubtasks();
            this.handlePriority();

            $.leavePage = function(){
                $.slidePanel = null;
            };
        }
    };
    
})(document, window, jQuery);
</script>